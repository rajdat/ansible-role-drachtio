<drachtio>

  <!-- Admin interface: port + secret -->
  <admin port="{{ drachtioAdminPort | default(9022) }}" secret="{{ drachtioSecret | default('changeme') }}">
    {{ drachtioAdminInterface | default('0.0.0.0') }}
  </admin>

  <!-- Optional HTTP request handlers -->
  {% if drachtioHttpHandler is defined and drachtioHttpHandler %}
  <request-handlers>
    <request-handler sip-method="*" http-method="GET">{{ drachtioHttpHandler }}</request-handler>
  </request-handlers>
  {% endif %}

  <!-- SIP configuration -->
  <sip>
    <contacts>
      <contact>sip:{{ ansible_default_ipv4.address }};transport=udp,tcp</contact>
    </contacts>

    <!-- Block known SIP scanners -->
    <spammers action="reject" tcp-action="discard">
      <header name="User-Agent">
        <value>sip-cli</value>
        <value>sipcli</value>
        <value>friendly-scanner</value>
      </header>
      <header>
        <value>sipvicious</value>
      </header>
    </spammers>

    <udp-mtu>4096</udp-mtu>

    <!-- TLS (disabled by default; enable if certs exist) -->
    {% if enable_tls | default(false) %}
    <tls>
      <key-file>/etc/letsencrypt/live/{{ tls_domain }}/privkey.pem</key-file>
      <cert-file>/etc/letsencrypt/live/{{ tls_domain }}/cert.pem</cert-file>
      <chain-file>/etc/letsencrypt/live/{{ tls_domain }}/chain.pem</chain-file>
      <dh-param>/var/local/dh4096.pem</dh-param>
    </tls>
    {% endif %}
  </sip>

  <!-- Enable CDR logging -->
  <cdrs>true</cdrs>

  <!-- Optional monitoring (Prometheus) -->
  {% if enable_prometheus | default(false) %}
  <monitoring>
    <prometheus port="{{ prometheus_port | default(8088) }}">127.0.0.1</prometheus>
  </monitoring>
  {% endif %}

  <!-- Logging configuration -->
  <logging>
    <file>
      <name>{{ drachtioLogFileDirectory }}/{{ drachtioLogFilePattern }}</name>
      <archive>{{ drachtioLogArchiveDirectory }}</archive>
      <size>{{ drachtioLogFileSize }}</size>
      <maxSize>{{ drachtioLogFileMaxSize }}</maxSize>
      <maxFiles>30</maxFiles>
      <auto-flush>true</auto-flush>
    </file>

    <!-- Sofia internal log level, from 0 (minimal) to 9 (verbose) -->
    <sofia-loglevel>3</sofia-loglevel>

    <!-- notice, warning, error, info, debug (default: info) -->
    <loglevel>{{ drachtioLogLevel | default('info') }}</loglevel>
  </logging>

</drachtio>

